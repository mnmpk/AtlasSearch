<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link href="css/mdbfonts.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />
    <link href="css/leafy.css" rel="stylesheet" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>
<body>
    <!--div class="parent">
        <div class="child">
                <img src="/BrandAssets/Illustrations/Technical_CONTENT_Presentation_Spot_BS_ForestGreen.png" style="width:50%" />
                <h2 style="text-align:center">Movie Search</h2>
                <div class="input-group input-group-lg">
                    <input type="text" class="form-control" placeholder="Search Content...">
                    <img src='/BrandAssets/Icons/Technical_ATLAS_Search10x.png' width="50" class="btn btn-search" />
                  </div>
        </div>
    </div-->
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!--button class="btn btn-mist btn-toggler" @onclick="ToggleMenu">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                
                <div class="side-panel fadeIn">
                    <div class="scrollable">
                        <h1>Rapid Development Menu</h1>
                
                        <p>Welcome expert programmer!</p>
                        
                        <p>With the click of single button in this menu, you can iterate through several versions of this application to 
                            continually refine the user experience (UX). In doing so, what happens behind the scenes is new refinements will 
                            be made to the Atlas Search Index to introduce new features to the application. Each version is a superset 
                            of features from the last.</p>
                
                        <p>Get developin'</p>
                
                        <ul>
                            <li><a href="/Search01">Version 1</a> - This will use standard MongoDB "<code>FindOne</code>" or "<code>$match</code>" database queries without Atlas Search. 
                                It will require an exact match of an ObjectID to find anything.</li>
                
                            <li><a href="/Search02">Version 2</a> - Our first iteration of using Atlas Search using a 
                                <a href="https://github.com/graboskyc/AtlasSearchLocalNYC2023/blob/main/Indexes/default.json" target="_blank">default index</a>.
                                <ul>
                                    <li>If you didn't have Atlas Search built in, you may need something like <button class="btn btn-success btn-sm"  @onclick="@(e =>ShowModalArch = true)">this</button></li>
                                    <li>All we had to do to turn this on is press five mouse clicks like <button class="btn btn-success btn-sm"  @onclick="@(e =>ShowModalIndex = true)">this</button></li>
                                </ul>    
                            </li>
                
                            <li><a href="/Results03/ghostbusters">Version 3</a> - Introduces showing the search score and highlighting to the user so the user 
                                can understand relevance. It also uses custom sorting to sort by year rather than relevance. It uses a 
                                <a href="https://github.com/graboskyc/AtlasSearchLocalNYC2023/blob/main/Indexes/sort.json" target="_blank">refined index</a> 
                                that only indexes the fields used (<code>fullplot</code>, <code>title</code>, and <code>year</code>).</li>
                
                            <li><a href="/Results04/ghostbusters">Version 4</a> - Adds a recommendation engine utilizing MoreLikeThis inside the Search stage. The 
                                <a href="https://github.com/graboskyc/AtlasSearchLocalNYC2023/blob/main/AtlasSearchNYC/Shared/MLT.razor#L62-L65" target="_blank">code to do so</a> 
                                is easy.</li>
                
                            <li><a href="/Results05">Version 5</a> - People are lazy so this adds an autocompelte to the text box. This requires a slight 
                                <a href="https://github.com/graboskyc/AtlasSearchLocalNYC2023/blob/main/Indexes/autocomplete.json" target="_blank">refinement</a> 
                                to the index.</li>
                
                            <li><a href="/Results06">Version 6</a> - Now we are really showing off. This brings all the features together. We have autocompelte, 
                            the search, highlighting, MoreLikeThis, sorting, and more. But now we added facets. We can keep using the same index as before, but instead 
                            of issuing a <code>$search</code> aggregation, we can use a <code>$searchmeta</code> stage to get metadata. In this case, we are faceting (getting a list of) the 
                            <code>genre</code>s and <code>cast</code> in the results, building that into a selectable list, and then can compound our search with any 
                            that were selected. Lastly, we can use facets for another interesting use case by enhancing our recommendation engine to recommend other movies 
                            with a specific cast member.</li>
                
                        </ul>
                    </div>
                </div-->
                <div class="row">
                    <h1>Search Results</h1>
                </div>

                <div class="row">
                    <div class="col-auto">
                        <h2><label for="ddl" class="form-label">Sort By</label></h2>
                        <div class="input-group">
                            <select class="form-select form-select-lg sortbox" id="ddl" @onchange=ChangeSort>
                                <option>Score</option>
                                <option>Release Year</option>                
                            </select>
                        </div>
                    </div>

                    <div class="col-auto">
                        @if(facet != null) {
                            <h2>Genres</h2>
                            <div class="form-check">
                                <select class="form-select" name="genres" id="genres" @bind="SelectedGenres" multiple>
                                    @foreach (var f in facet.Genres)
                                    {
                                        <option value="@f.Key">@f.Key (@f.Count)</option>
                                    }
                                </select>
                            </div>
                        }
                    </div>

                    <div class="col-auto">
                        @if(facet != null) {
                            <h2>Cast</h2>
                            <div class="form-check">
                                <select class="form-select" name="cast" id="cast" @bind="SelectedCast" multiple>
                                    @foreach (var f in facet.Cast)
                                    {
                                        <option value="@f.Key">@f.Key (@f.Count)</option>
                                    }
                                </select>
                            </div>
                        }
                    </div>

                    <div class="col-auto">
                        <button class="btn btn-lg btn-leafy" @onclick=RunSearchButton>Search</button>
                    </div>
                </div>

                <div class="row">
                  <div class="input-group input-group-lg">
                    <input type="text" 
                        class="form-control" 
                        placeholder="Search Content..." 
                        @bind-value="SearchTerm" 
                        @bind-value:event="oninput" 
                        @onkeydown="@CheckEnterKey">
                    <img src='/BrandAssets/Icons/Technical_ATLAS_Search10x.png' 
                        width="50" class="btn btn-search" 
                        @onclick="() => RedirectSearch()" />
                  </div>
                  
                  @if (suggestions is not null && ShowSuggestions)
                    {
                        <ul class="options" @onclick=ToggleSuggestions>
                            @if (suggestions.Any())
                            {
                                @foreach (var s in suggestions.Take(5))
                                {
                                    <li class="option input-group" @onclick="() => RedirectSearch(s.Title)">
                                      <span class="option-text">@s.Title</span>
                                    </li>                    
                                }
                            }
                            <li class="option input-group" @onclick="() => RedirectSearch()" >
                                See Full Results for "@SearchTerm"
                            </li>
                        </ul>
                    }    
                </div>          

                <div class="row" style="margin-top:20px;">
                    @for
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Year</h5>

                            @if(SourceMovie.Highlights.Count == 0) {
                                <p class="card-text">@SourceMovie.Plot</p>
                            } else {
                                <p class="card-text">
                                    @foreach(var h in SourceMovie.Highlights) {
                                        @foreach(var hightext in h.Texts) {
                                            @if(hightext.ReasonForSplit == "hit") {
                                                <span class="highlight-hit">@hightext.Section</span>
                                            } else {
                                                <span>@hightext.Section</span>
                                            }
                                        }
                                    }
                                </p>
                            }

                            @if(ShowButton) {
                                <center><button class="btn btn-leafy btn-sm" @onclick="RunSearch">Find More Like This</button></center>
                            } else {
                                @if(similarMovies != null) {
                                    @foreach (var t in similarMovies)
                                    {
                                        @if(t.PosterImageUrl != null) {
                                            <img class="moviePoster" src="@t.PosterImageUrl" width="50px" @onclick=@(e => MovieClick(t.Title)) />
                                        } else {
                                            <div class="moviePoster"  @onclick=@(e => MovieClick(t.Title))>@t.Title</div>
                                        }
                                    }
                                } else {
                                    <p>This is unique!</p>
                                }
                            }


                            <div class="card-footer text-muted">
                                Score: @SourceMovie.SearchScore
                            </div>

                            <button class="btn btn-leafy btn-sm" @onclick="LearnMoreClicked" data-bs-toggle="modal" data-bs-target="#ctr_modal" >Learn More</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <script src="js/json-formatter.js"></script>
    <script>
        var errCt = 0;
        window.makeJsonPrettyGlobal = function() {
            if(errCt < 5) {
                try {
                    const toRenderDivs = document.querySelectorAll("div.prepareForPrettyJson");
                    if(toRenderDivs.length == 0) {
                        setTimeout(makeJsonPrettyGlobal(), 500);
                    } else {
                        toRenderDivs.forEach(function(toRender) {
                            console.log(toRender.innerText);
                            const rawJsonAsText = toRender.innerText;
                            const rawJson = JSON.parse(rawJsonAsText);
                            // https://www.npmjs.com/package/json-formatter-js
                            const formatted = new JSONFormatter(rawJson, 0);

                            toRender.removeChild(toRender.firstChild);
                            toRender.appendChild(formatted.render());
                            toRender.classList.remove("prepareForPrettyJson");
                        });
                    }
                } catch (err) {
                    console.log(errCt);
                    console.log(err);
                    errCt++;
                    setTimeout(makeJsonPrettyGlobal, 500);
                }
            }
        }
    </script>

</body>
</html>
